#!/usr/bin/env bash

# Set the directory containing Markdown files
SCRIPT_DIR=$(dirname "$0")
INPUT_DIR=$(cd "$(dirname "$SCRIPT_DIR")" && pwd)
OUTPUT_DIR="$INPUT_DIR/output"

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

convert_to_epub() {
	# convert all EPUB files into a single EPUB book
	OUTPUT_BOOK="$OUTPUT_DIR/ddia.pdf"
	rm -f "$OUTPUT_BOOK"
	echo "Converting all EPUB files into $OUTPUT_BOOK..."

	local meta_file=${INPUT_DIR}/metadata.yaml
	local css_file=${INPUT_DIR}/js/epub.css

    ${INPUT_DIR}/mergemd.sh

    pandoc -o $OUTPUT_BOOK \
	    --metadata-file="$meta_file" \
        --toc-depth=2 \
        --top-level-division=chapter \
        --pdf-engine=xelatex \
        --from markdown \
		--file-scope \
        --template=${INPUT_DIR}/template.tex \
        --highlight-style=pygments \
        -V colorlinks=true \
        -V linkcolor=blue \
        -V urlcolor=blue \
        -V lang=zh-CN \
        -V geometry:margin=1in \
        --css="$css_file" \
        --webtex \
        --wrap=preserve \
        "${OUTPUT_DIR}"/merged.md
         
	echo "Converted EPUB book created at $OUTPUT_BOOK."
}

convert_to_epub
